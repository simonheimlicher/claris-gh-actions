name: Build and Deploy Hugo Site

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      # The base URL on the custom domain of your Cloudflare Pages project
      BASE_URL:
        required: true
        type: string
      # The base URL for the debug project (unminified builds)
      BASE_URL_DEBUG:
        required: true
        type: string
      # The canonical base URL (only has an effect if it differs from the base URL)
      CANONICAL_BASE_URL:
        required: false
        type: string
      HUGO_VERSION:
        required: true
        type: string
      DART_SASS_VERSION:
        required: true
        type: string
      CLOUDFLARE_PROJECT_NAME:
        type: string
        required: true
      CLOUDFLARE_PROJECT_NAME_DEBUG:
        type: string
        required: true
    secrets:
      HUGO_CLARIS_AUTHOR_EMAIL:
        required: true
      # Cloudflare Zone ID is required for manual cache purging
      CLOUDFLARE_ZONE_ID:
        required: true
      CLOUDFLARE_API_TOKEN:
        required: true
      CLOUDFLARE_ACCOUNT_ID:
        required: true

jobs:
  # Build with production settings (minified)
  build-prod:
    uses: simonheimlicher/claris-gh-actions/.github/workflows/build-hugo.yml@main
    with:
      BASE_URL: ${{ inputs.BASE_URL }}
      CANONICAL_BASE_URL: ${{ inputs.CANONICAL_BASE_URL }}
      HUGO_VERSION: ${{ inputs.HUGO_VERSION }}
      HUGO_ENVIRONMENT: prod
      DART_SASS_VERSION: ${{ inputs.DART_SASS_VERSION }}
      ARTIFACT_SUFFIX: prod
    secrets:
      HUGO_CLARIS_AUTHOR_EMAIL: ${{ secrets.HUGO_CLARIS_AUTHOR_EMAIL }}

  # Build with debug settings (unminified, source maps, etc.)
  # Uses BASE_URL_DEBUG for asset paths but CANONICAL_BASE_URL points to production
  build-debug:
    uses: simonheimlicher/claris-gh-actions/.github/workflows/build-hugo.yml@main
    with:
      BASE_URL: ${{ inputs.BASE_URL_DEBUG }}
      CANONICAL_BASE_URL: ${{ inputs.CANONICAL_BASE_URL }}
      HUGO_VERSION: ${{ inputs.HUGO_VERSION }}
      HUGO_ENVIRONMENT: debug
      DART_SASS_VERSION: ${{ inputs.DART_SASS_VERSION }}
      ARTIFACT_SUFFIX: debug
    secrets:
      HUGO_CLARIS_AUTHOR_EMAIL: ${{ secrets.HUGO_CLARIS_AUTHOR_EMAIL }}

  # Deploy production build to main project
  deploy-prod:
    needs: build-prod
    uses: simonheimlicher/claris-gh-actions/.github/workflows/deploy-cloudflare-pages.yml@main
    with:
      BASE_URL: ${{ inputs.BASE_URL }}
      CLOUDFLARE_PROJECT_NAME: ${{ inputs.CLOUDFLARE_PROJECT_NAME }}
      ARTIFACT_SUFFIX: prod
    secrets:
      CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  # Deploy debug build to debug project
  deploy-debug:
    needs: build-debug
    uses: simonheimlicher/claris-gh-actions/.github/workflows/deploy-cloudflare-pages.yml@main
    with:
      BASE_URL: ${{ inputs.BASE_URL_DEBUG }}
      CLOUDFLARE_PROJECT_NAME: ${{ inputs.CLOUDFLARE_PROJECT_NAME_DEBUG }}
      ARTIFACT_SUFFIX: debug
    secrets:
      CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
